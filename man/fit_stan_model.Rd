% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit_stan.R
\name{fit_stan_model}
\alias{fit_stan_model}
\title{Fit a Bayesian two-stage model using Stan}
\usage{
fit_stan_model(
  data,
  main_model_formula,
  imputation_model_formula,
  imputation_distribution = c("normal", "bernoulli", "beta_binomial",
    "negative_binomial"),
  parameterization = c("noncentered", "centered", "marginalized", "marginalized_mixture"),
  inference_method = c("mcmc", "pathfinder", "laplace", "optimize"),
  pathfinder_draws = 1000L,
  pathfinder_num_paths = 4L,
  laplace_draws = 1000L,
  optimize_algorithm = c("lbfgs", "bfgs", "newton"),
  optimize_iter = 2000L,
  mixture_components = 3L,
  use_pathfinder_init = FALSE,
  n_chains = 4L,
  iter_warmup = 1000L,
  iter_sampling = 1000L,
  adapt_delta = 0.8,
  seed = 777L,
  parallel_chains = 1L
)
}
\arguments{
\item{data}{A data frame containing the outcome and covariates}

\item{main_model_formula}{One-sided formula or string for covariates in the
main model (e.g., \code{~ age + splines::ns(bmi, 3)}). Intercept is
automatically removed.}

\item{imputation_model_formula}{One-sided formula or string for covariates
in the imputation model (e.g., \code{~ age + factor(site)}). Intercept is
automatically removed.}

\item{imputation_distribution}{Distribution for the imputation model:
"normal" for continuous x, "bernoulli" for binary x, "beta_binomial"
for bounded count data, or "negative_binomial" for unbounded count data
(default: "normal")}

\item{parameterization}{Parameterization for random effects:
\itemize{
\item "noncentered" (default): Works better with weakly informative data (small N)
\item "centered": Works better with highly informative data (large N)
\item "marginalized": Integrates out random effects and missing x analytically.
Eliminates funnel geometry but has O(G * n_g^3) likelihood cost per subject.
Best for datasets with sampling issues. Available for all distributions.
Note: Beta-binomial marginalized requires all subjects have the same n_trials.
\item "marginalized_mixture": Like "marginalized" but models x with a mixture of
normals for multimodal distributions. Only available for normal imputation.
Requires specifying \code{mixture_components}.
}}

\item{inference_method}{Inference method to use:
\itemize{
\item "mcmc" (default): Full MCMC sampling via NUTS. Most accurate but slowest.
\item "pathfinder": Variational inference via Pathfinder algorithm. Fast approximate
inference with posterior draws. Good for initial exploration.
\item "laplace": Laplace approximation. Finds posterior mode and approximates with
Gaussian. Very fast with good accuracy for well-behaved posteriors.
\item "optimize": Maximum a posteriori (MAP) point estimate only. Fastest but no
uncertainty quantification. Returns CmdStanMLE object (no posterior draws).
}}

\item{pathfinder_draws}{Number of approximate posterior draws from Pathfinder
(default: 1000L)}

\item{pathfinder_num_paths}{Number of Pathfinder paths to run (default: 4L)}

\item{laplace_draws}{Number of approximate posterior draws from Laplace
(default: 1000L)}

\item{optimize_algorithm}{Optimization algorithm for MAP estimation:
"lbfgs" (default), "bfgs", or "newton"}

\item{optimize_iter}{Maximum iterations for optimization (default: 2000L)}

\item{mixture_components}{Number of mixture components for the imputation model
when using \code{parameterization = "marginalized_mixture"} (default: 3L)}

\item{use_pathfinder_init}{Logical; if TRUE, use Pathfinder variational inference
to initialize MCMC chains. Only applies when \code{inference_method = "mcmc"}.
This can dramatically improve sampling efficiency for complex models with
many latent parameters (default: FALSE)}

\item{n_chains}{Number of MCMC chains (default: 4)}

\item{iter_warmup}{Number of warmup iterations per chain (default: 1000)}

\item{iter_sampling}{Number of sampling iterations per chain (default: 1000)}

\item{adapt_delta}{Target acceptance rate for HMC (default: 0.8)}

\item{seed}{Random seed for reproducibility (default: 777L)}

\item{parallel_chains}{Number of chains to run in parallel (default: 1L)}
}
\value{
A CmdStan fit object. Type depends on \code{inference_method}:
CmdStanMCMC (mcmc), CmdStanPathfinder (pathfinder), CmdStanLaplace (laplace),
or CmdStanMLE (optimize). All support \verb{$summary()}, but only mcmc/pathfinder/laplace
support \verb{$draws()} for posterior samples.
}
\description{
Fits a mixed effects model with imputation using Stan via the instantiate package.
}
