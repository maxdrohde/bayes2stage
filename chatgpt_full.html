<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bayesian Two-Stage Designs for Longitudinal Studies with Costly Covariates • bayes2stage</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Bayesian Two-Stage Designs for Longitudinal Studies with Costly Covariates"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">bayes2stage</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/bayes2stage.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/maxdrohde/bayes2stage/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Bayesian Two-Stage Designs for Longitudinal Studies with Costly Covariates</h1>
      <small class="dont-index">Source: <a href="https://github.com/maxdrohde/bayes2stage/blob/master/chatgpt_full.md" class="external-link"><code>chatgpt_full.md</code></a></small>
    </div>

<div id="bayesian-two-stage-designs-for-longitudinal-studies-with-costly-covariates" class="section level1">

<p><em>Draft for development; replace placeholder items (data source, numbers) with study specifics.</em></p>
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a></h2>
<p>Two-stage designs are attractive when a key covariate (e.g., biomarker or omics assay) is costly but longitudinal outcomes are widely available. We propose a Bayesian joint modeling framework that combines mixed-effects outcome models with covariate imputation, enabling efficient inference when the costly covariate is measured on a subsample selected by outcome- or BLUP-dependent rules. The <code>bayes2stage</code> package implements unified Stan models for continuous, binary, and count covariates (negative binomial, beta-binomial), optimized for computational efficiency. We compare outcome-dependent sampling (ODS), BLUP-dependent sampling (BDS), and simple random sampling (SRS) across a broad set of simulation scenarios, and benchmark against an ascertainment-corrected maximum likelihood (ACML) estimator. Results show that tail-focused ODS/BDS strategies yield substantial precision gains for covariate effects at modest costs, with well-calibrated uncertainty under correct imputation families. We illustrate the approach in a case study and provide open-source code for full reproducibility.</p>
<p><strong>Keywords:</strong> two-stage design; outcome-dependent sampling; BLUP-dependent sampling; missing covariates; mixed-effects models; Bayesian imputation; Stan; ascertainment correction.</p>
</div>
<div class="section level2">
<h2 id="id_1-introduction">1. Introduction<a class="anchor" aria-label="anchor" href="#id_1-introduction"></a></h2>
<p>Measuring expensive biomarkers or genetic assays on every participant is often infeasible. In longitudinal studies, repeated outcomes and inexpensive covariates are typically observed on all subjects. Two-stage designs exploit this structure: stage 1 collects inexpensive measures on everyone; stage 2 selects a subsample for the costly covariate, often oversampling subjects with extreme trajectories to maximize information.</p>
<p>Existing approaches either ignore stage-2 sampling in downstream inference (leading to bias or inefficiency) or rely on frequentist ascertainment corrections specialized to particular designs. Bayesian methods can jointly model the outcome and missing covariate, propagate uncertainty, and flexibly handle diverse covariate types, but practical, optimized implementations are scarce. We develop a unified Bayesian framework for two-stage longitudinal studies and provide an open-source implementation in <code>bayes2stage</code>. The framework supports SRS, ODS (intercept/slope strata from OLS fits), and BDS (intercept/slope strata from mixed-model BLUPs). It handles continuous, binary, and bounded/unbounded count covariates with optimized Stan code that marginalizes discrete covariates when possible. We benchmark against an ascertainment-corrected maximum likelihood (ACML) estimator and provide design guidance through simulations and a case study.</p>
</div>
<div class="section level2">
<h2 id="id_2-methods">2. Methods<a class="anchor" aria-label="anchor" href="#id_2-methods"></a></h2>
<div class="section level3">
<h3 id="id_21-data-structure-and-outcome-model">2.1 Data structure and outcome model<a class="anchor" aria-label="anchor" href="#id_21-data-structure-and-outcome-model"></a></h3>
<p>Subjects (i=1,,N) are observed at times (j=1,,M_i) (often a common M). The outcome model is [ y_{ij} = + <em>x x_i + <em>z z_i + (<em>t + b</em>{1i}) t</em>{ij} + </em>{tx} x_i t_{ij} + b_{0i} + <em>{ij}, ] with correlated random intercept/slope ((b</em>{0i}, b_{1i}) (0, ) ) and residuals (<em>{ij} (0, </em>{}^2)). Time is scaled 0–1. Covariate z is inexpensive and observed for all subjects; x is expensive, measured only for the stage-2 sample.</p>
</div>
<div class="section level3">
<h3 id="id_22-stage-2-sampling-strategies">2.2 Stage-2 sampling strategies<a class="anchor" aria-label="anchor" href="#id_22-stage-2-sampling-strategies"></a></h3>
<ul><li>
<strong>SRS:</strong> random subsample of subjects via <code><a href="reference/srs_design.html">srs_design()</a></code>.</li>
<li>
<strong>ODS:</strong> define strata on OLS intercepts or slopes (<code><a href="reference/ods_design.html">ods_design()</a></code>), using quantiles (cutoff_low/high) and prespecified stratum proportions; oversample tails to emphasize informative trajectories.</li>
<li>
<strong>BDS:</strong> define strata on BLUP intercepts or slopes from a mixed-effects model (<code><a href="reference/bds_design.html">bds_design()</a></code>); requires sufficient time points for stable BLUPs and is sensitive to random-effect variance magnitude.</li>
</ul></div>
<div class="section level3">
<h3 id="id_23-bayesian-joint-model-with-imputation">2.3 Bayesian joint model with imputation<a class="anchor" aria-label="anchor" href="#id_23-bayesian-joint-model-with-imputation"></a></h3>
<p>We jointly model y and x. Implementation uses optimized Stan code in <code>src/stan/</code>.</p>
<ul><li>
<strong>Outcome component:</strong> non-centered random effects with Cholesky factor (L_{re}) and SDs (_{re}); fixed effects (_x, <em>z, <em>t, </em>{tx}); Gaussian residual variance (</em>{}^2). Likelihood is vectorized; subject indices (<code>id</code>, <code>pos</code>, <code>len</code>) broadcast random effects efficiently.</li>
<li>
<strong>Imputation component (subject-level x):</strong>
<ul><li>Normal: linear regression with SD (_{}).</li>
<li>Bernoulli: logit link.</li>
<li>Negative binomial: log mean with dispersion ().</li>
<li>Beta-binomial: logit mean with concentration () and known trials (n_{}).</li>
</ul></li>
<li>
<strong>Missing x handling:</strong> continuous x uses latent draws; discrete x are marginalized with <code>log_sum_exp</code> to avoid discrete parameters and improve mixing.</li>
<li>
<strong>Priors:</strong> exponential on scale parameters (rate 0.1), weakly informative normals on fixed effects (mean 0, sd 100 for main effects; sd 2.5 on imputation logits), LKJ prior on correlation via <code>lkj_corr_cholesky</code>. These choices balance weak informativeness with computational stability.</li>
<li>
<strong>Diagnostics:</strong> R-hat, ESS, divergences, E-BFMI; graphical PPCs for y and x; calibration of imputed x.</li>
</ul></div>
<div class="section level3">
<h3 id="id_24-frequentist-comparator-acml">2.4 Frequentist comparator (ACML)<a class="anchor" aria-label="anchor" href="#id_24-frequentist-comparator-acml"></a></h3>
<p>For ODS designs, <code><a href="reference/fit_acml_ods.html">fit_acml_ods()</a></code> implements ascertainment-corrected ML. Known sampling probabilities by stratum correct the likelihood; robust standard errors provide inference. This serves as a comparator for the Bayesian approach under ODS (intercept/slope) designs.</p>
</div>
<div class="section level3">
<h3 id="id_25-computational-considerations">2.5 Computational considerations<a class="anchor" aria-label="anchor" href="#id_25-computational-considerations"></a></h3>
<ul><li>Stan models leverage precomputed subject indices (<code>pos</code>, <code>len</code>) and vectorization to reduce gradient evaluations.</li>
<li>Discrete x models integrate out x to avoid discrete parameters.</li>
<li>Parallel chains via <code>parallel_chains</code>; adapt_delta tuned to reduce divergences.</li>
<li>Seeds via Cantor pairing for reproducibility across simulation cells.</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="id_3-simulation-study">3. Simulation Study<a class="anchor" aria-label="anchor" href="#id_3-simulation-study"></a></h2>
<div class="section level3">
<h3 id="id_31-objectives">3.1 Objectives<a class="anchor" aria-label="anchor" href="#id_31-objectives"></a></h3>
<p>Assess: 1) Bias/RMSE and 95% coverage for (<em>x) and (</em>{tx}); 2) Interval width and power/type I error; 3) Imputation quality for x (MAE, calibration); 4) Cost-adjusted precision; 5) Computational performance (runtime, ESS/sec, divergences).</p>
</div>
<div class="section level3">
<h3 id="id_32-data-generating-mechanisms">3.2 Data-generating mechanisms<a class="anchor" aria-label="anchor" href="#id_32-data-generating-mechanisms"></a></h3>
<p>Use <code><a href="reference/generate_data.html">generate_data()</a></code> and <code>generate_data_schild_2019_supp</code> variants: - <strong>Sample sizes:</strong> N ∈ {500, 1000, 2000}; time points M ∈ {3, 5, 8}. - <strong>Random effects:</strong> SDs {1, 2, 4}; correlations {0, 0.3, 0.6}; residual SD {1, 2, 4} (scale to scenario). - <strong>Effects:</strong> (<em>x) ∈ {0, 0.3, 0.6, 1.0}; (</em>{tx}) ∈ {0, 0.2, 0.4}. - <strong>Covariate types:</strong> normal; Bernoulli (p=0.2, 0.5); negative binomial (vary mean/dispersion); beta-binomial (vary trials/concentration). - <strong>Auxiliary strength:</strong> gamma coefficients linking z→x at weak/medium/strong (e.g., gamma1 ∈ {0.2, 0.6, 1.0}).</p>
</div>
<div class="section level3">
<h3 id="id_33-design-factors">3.3 Design factors<a class="anchor" aria-label="anchor" href="#id_33-design-factors"></a></h3>
<ul><li>Sampling fractions: 5%, 10%, 20%, 40% of subjects measured for x.</li>
<li>Strata cutoffs: (0.2, 0.8) and (0.25, 0.75); stratum proportions symmetric vs tail-heavy (e.g., 0.4/0.2/0.4 low/mid/high).</li>
<li>Designs: SRS, ODS-intercept, ODS-slope, BDS-intercept, BDS-slope.</li>
<li>Misspecification: design on slope when (_{tx}=0); fit wrong imputation family (e.g., normal to count x) to test robustness.</li>
</ul></div>
<div class="section level3">
<h3 id="id_34-estimators">3.4 Estimators<a class="anchor" aria-label="anchor" href="#id_34-estimators"></a></h3>
<ul><li>Bayesian joint model (correctly specified) for each x family.</li>
<li>Bayesian joint model with imputation misspecification (robustness stress).</li>
<li>ACML for ODS.</li>
<li>Naive complete-case ignoring design.</li>
<li>Oracle (full x observed) for efficiency benchmark.</li>
</ul></div>
<div class="section level3">
<h3 id="id_35-metrics-and-analysis-plan">3.5 Metrics and analysis plan<a class="anchor" aria-label="anchor" href="#id_35-metrics-and-analysis-plan"></a></h3>
<ul><li>Compute bias, RMSE, interval width, and coverage for (<em>x, </em>{tx}) per cell; summarize across replicates (≥500 per cell) with means and quantiles.</li>
<li>Power/type I error from rejection of (H_0: _x=0).</li>
<li>Relative efficiency: variance ratio vs oracle and vs SRS.</li>
<li>Imputation: MAE of x among missing subjects; calibration of x posteriors (coverage of latent draws for discrete x).</li>
<li>Cost-adjusted precision: precision per cost unit with stage-2 cost multiplier (e.g., 10× stage-1).</li>
<li>Computational: wall-clock, ESS/sec, divergences; flag problematic settings.</li>
</ul></div>
<div class="section level3">
<h3 id="id_36-expected-qualitative-patterns-to-verify">3.6 Expected qualitative patterns (to verify)<a class="anchor" aria-label="anchor" href="#id_36-expected-qualitative-patterns-to-verify"></a></h3>
<ul><li>Tail-focused ODS/BDS should reduce RMSE and interval width for (_x), especially when effects moderate/large and sampling 10–30% of subjects.</li>
<li>BDS may outperform ODS when BLUPs are stable (larger M, larger RE variance); ODS more robust at small M.</li>
<li>Misspecified imputation degrades coverage for discrete x; normal fit to counts inflates bias when dispersion large.</li>
<li>Power gains taper beyond ~20–30% sampling; cost-adjusted efficiency plateaus.</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="id_4-results-populate-with-outputs">4. Results (populate with outputs)<a class="anchor" aria-label="anchor" href="#id_4-results-populate-with-outputs"></a></h2>
<div class="section level3">
<h3 id="id_41-main-simulation-tables">4.1 Main simulation tables<a class="anchor" aria-label="anchor" href="#id_41-main-simulation-tables"></a></h3>
<ul><li>Bias/RMSE/coverage for (<em>x, </em>{tx}) by design and x type.</li>
<li>Relative efficiency vs SRS and oracle; power/type I error summaries.</li>
</ul></div>
<div class="section level3">
<h3 id="id_42-figures">4.2 Figures<a class="anchor" aria-label="anchor" href="#id_42-figures"></a></h3>
<ul><li>Efficiency vs sampling fraction curves (per design, per x type).</li>
<li>Forest/ridge plots of (<em>x, </em>{tx}) posteriors across designs; overlay ACML point/CI.</li>
<li>Imputation diagnostics: observed vs imputed x distributions; calibration plots for discrete x; scatter of true vs posterior mean x among missing cases.</li>
<li>Cost vs precision trade-offs; computational diagnostics (ESS/sec, divergences).</li>
<li>Design visuals: density of OLS/BLUP intercepts/slopes with cutoff lines; selection heatmaps over time.</li>
</ul></div>
<div class="section level3">
<h3 id="id_43-sensitivity-analyses">4.3 Sensitivity analyses<a class="anchor" aria-label="anchor" href="#id_43-sensitivity-analyses"></a></h3>
<ul><li>Vary adapt_delta/step size to assess robustness of HMC diagnostics.</li>
<li>Alternative priors (tighter/looser scales) for stability and shrinkage effects.</li>
<li>Impact of weaker z–x association on imputation performance.</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="id_5-case-study-insert-application">5. Case Study (insert application)<a class="anchor" aria-label="anchor" href="#id_5-case-study-insert-application"></a></h2>
<ul><li>
<strong>Setting:</strong> describe population, outcome, expensive covariate, and auxiliary z.</li>
<li>
<strong>Design:</strong> construct ODS/BDS strata (intercept or slope), report cutoffs and achieved sampling fractions; compare to hypothetical SRS.</li>
<li>
<strong>Models:</strong> fit Bayesian joint model matching x type; fit ACML for ODS if applicable.</li>
<li>
<strong>Outputs:</strong> effect estimates with intervals; posterior predictive checks for y and x; selection visualizations; forest plot of key effects; trajectory plots for sampled vs unsampled subjects.</li>
<li>
<strong>Interpretation:</strong> practical implications of estimated (<em>x, </em>{tx}); cost implications of sampling strategy.</li>
</ul></div>
<div class="section level2">
<h2 id="id_6-discussion">6. Discussion<a class="anchor" aria-label="anchor" href="#id_6-discussion"></a></h2>
<ul><li>
<strong>Key findings:</strong> tail-focused two-stage designs with joint Bayesian imputation improve efficiency for costly covariate effects; gains largest when effects or trajectory heterogeneity are moderate/large and auxiliary z is informative.</li>
<li>
<strong>Design guidance:</strong> pick cutoffs to target informative tails; ensure enough time points for BLUP stability before using BDS; sample 10–30% when costs are high; align design with estimand (use slope-based strata when interaction is primary target).</li>
<li>
<strong>Robustness:</strong> correct imputation family matters for discrete x; auxiliary z improves calibration; BDS sensitive to M and RE variance; ODS simpler and more stable when M is small.</li>
<li>
<strong>Limitations:</strong> assumes MAR given design variables; linear trajectories; baseline (time-invariant) x; no measurement error in x; computation grows with N despite vectorization.</li>
<li>
<strong>Future work:</strong> time-varying expensive covariates; nonlinear trajectories; informative dropout; adaptive or response-adaptive designs; alternative priors and variational approximations for scalability.</li>
</ul></div>
<div class="section level2">
<h2 id="id_7-software-and-reproducibility">7. Software and Reproducibility<a class="anchor" aria-label="anchor" href="#id_7-software-and-reproducibility"></a></h2>
<ul><li>Package: <code>bayes2stage</code>; Stan code in <code>src/stan/</code>; design functions (<code><a href="reference/srs_design.html">srs_design()</a></code>, <code><a href="reference/ods_design.html">ods_design()</a></code>, <code><a href="reference/bds_design.html">bds_design()</a></code>); Bayesian fitting via <code><a href="reference/fit_stan_model.html">fit_stan_model()</a></code>; ACML via <code><a href="reference/fit_acml_ods.html">fit_acml_ods()</a></code>.</li>
<li>Reproducibility: publish simulation scripts, seeds, session info; recommend <code>renv</code> or containers; vignette (<code>vignettes/bayes2stage.qmd</code>) shows workflow.</li>
</ul></div>
<div class="section level2">
<h2 id="id_8-acknowledgments">8. Acknowledgments<a class="anchor" aria-label="anchor" href="#id_8-acknowledgments"></a></h2>
<p>[Insert funding, collaborators, and data acknowledgments.]</p>
</div>
<div class="section level2">
<h2 id="id_9-references">9. References<a class="anchor" aria-label="anchor" href="#id_9-references"></a></h2>
<p>[Insert citations for two-stage designs, ODS/BDS literature, ACML, Bayesian missing data, Stan references, and the applied domain.]</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Maximilian Rohde.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

